---
title: "cis-meQTLs Analysis"
subtitle: "Dexamethasone-Stimulated Human Array Project"
author: 
  - name: Anastasiia Hryhorzhevska
    email: anastasiia_hry@psych.mpg.de
    url: https://github.com/ahryho
    affiliation: Max Planck Institute of Psychiatry
    affiliation_url: https://www.psych.mpg.de/2664393/medizinische-genomforschung
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    df_print: paged
    css: style.css
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
options(digits = 4, width = 100, stringsAsFactors = T)
knitr::opts_chunk$set(echo = TRUE,
                      tidy.opts = list(width.cutoff = 100),
                      tidy=TRUE,
                      fig.pos = "H",
                      dpi = 200,
                      warning = FALSE, 
                      message = FALSE, 
                      cache = TRUE, 
                      cache.lazy = FALSE)

# define DT as the standard printing method for data.frame
library(knitr)
library(DT)
knit_print.data.frame <- function(x, ...) {
  knit_print(DT::datatable(x,
                           filter="top",
                           rownames = FALSE,
                           extensions = "FixedColumns",
                           options = list(
                             scrollX = TRUE,
                             pageLength = 5
                             
                           )), ...)
}

registerS3method("knit_print", "data.frame", knit_print.data.frame)

library(data.table)
library(dplyr)

library(ggplot2)
library(ggrepel)
library(scales)
library(GGally)
library(factoextra)
library(viridis)
```

***
# __MatrixEQTL Primary Results__
***

```{r load-func, include = F, eval = T}
source("~/bio/code/mpip/dex-stim-human-array/code/integrative/eqtl/04_me-qtl_analysis/util.R")
cbPalette <- c( "#0072B2", "#009E73", "#E69F00", "#F0E442", "#D55E00", "#CC79A7", "#56B4E9", "#999999")
```

```{r, include = F, eval = T}
src.dir.pre  <- "~/bio/code/mpip/dex-stim-human-array/data/integrative/matrixEQTL/"
out.dir.pre  <- "~/bio/code/mpip/dex-stim-human-array/output/data/integrative/matrixEQTL/"

cpg.loc.fn  <- paste0(src.dir.pre, "cpg_locations.csv")
snp.loc.fn  <- paste0(src.dir.pre, "snp_locations.csv")
# ensg.loc.fn <- paste0(src.dir.pre, "ensg_locations.csv")

cpg.loc  <- fread(cpg.loc.fn)
snp.loc  <- fread(snp.loc.fn)

# snp.bim  <- fread("~/bio/code/mpip/dex-stim-human-array/data/snps/final_imputed_qc_snps/mtrx/dex_geno_imputed_ld.bim")
snp.bim  <- fread("~/bio/code/mpip/dex-stim-human-array/data/snps/imputed_qc/from_janine/qc/Dex_genoData_SNPs.bim")
colnames(snp.bim) <- c("chr", "SNP", "pos_morgans", "pos", "snp_allele1", "snp_allele2")

meqtl.dex.fn   <- paste0(out.dir.pre, "me-eqtl_cis_results_06122021/me-qtl_cis_result_dex_fdr_005.csv")  # "me-qtl_cis_result_dex_fdr_005.csv")
meqtl.veh.fn   <- paste0(out.dir.pre, "me-eqtl_cis_results_06122021/me-qtl_cis_result_veh_fdr_005.csv") # "me-qtl_cis_result_veh_fdr_005.csv")
meqtl.delta.fn <- paste0(out.dir.pre, "me-qtl_cis_result_delta_fdr_005.csv") # "me-qtl_cis_result_delta_beta.csv")# 
# meqtl.delta.fn <- paste0("~/bio/code/mpip/dex-stim-human-array/output/data/integrative/matrixEQTL/geno_imputed_qc_ld/", "me-qtl_cis_result_delta.csv")

col.names <- c("SNP", "CpG_ID", "beta", "t-stat", "p-value", "FDR")

meqtl.dex.df   <- fread(meqtl.dex.fn, col.names = col.names)
meqtl.veh.df   <- fread(meqtl.veh.fn, col.names = col.names)
meqtl.delta.df <- fread(meqtl.delta.fn, col.names = col.names)
```

```{r, include = F, eval = F}
meqtl.rds <- readRDS("~/bio/code/mpip/dex-stim-human-array/output/data/integrative/matrixEQTL/me-eqtl_matrx_delta.RDS")
plot(meqtl.rds)
```


```{r, include = F, eval = T}
# head(meqtl.df)
fdr.thr  <- 0.05

meqtl.delta.full.df <- GetFullmeQTLdf(meqtl.delta.df, fdr.thr)
meqtl.dex.full.df   <- GetFullmeQTLdf(meqtl.dex.df, fdr.thr)
meqtl.veh.full.df   <- GetFullmeQTLdf(meqtl.veh.df, fdr.thr)
```

```{r, include = F, eval = T}
meqtl.all.full.df <- rbind(meqtl.dex.full.df[, treatment := "dex"],
                           meqtl.veh.full.df[, treatment := "veh"],
                           meqtl.delta.full.df[, treatment := "delta"])
meqtl.all.full.df[["meQTL_ID"]] <- paste(meqtl.all.full.df$SNP, meqtl.all.full.df$CpG_ID, sep = "-")
meqtl.all.full.df <- setDT(meqtl.all.full.df)
```

## Significant Hits, FDR < 0.05

Check the number of found eQTLs, unique CpGs and SNPs in all datasets.

```{r, include = F, eval = T}
sign.hits.df <- data.table(c(meqtl.delta.full.df$fdr  %>% length(), 
                             meqtl.delta.full.df$CpG_ID %>% unique() %>% length(),
                             meqtl.delta.full.df$SNP %>% unique() %>% length()),
                           c(meqtl.dex.full.df$fdr  %>% length(), 
                             meqtl.dex.full.df$CpG_ID %>% unique() %>% length(),
                             meqtl.dex.full.df$SNP %>% unique() %>% length()),
                           c(meqtl.veh.full.df$fdr  %>% length(), 
                             meqtl.veh.full.df$CpG_ID %>% unique() %>% length(),
                             meqtl.veh.full.df$SNP %>% unique() %>% length()))

sign.hits.df <- as.data.frame(sign.hits.df)
rownames(sign.hits.df) <- c("cis-meQTLs", "CpG", "SNP")
colnames(sign.hits.df) <- c("delta", "dex", "veh")
```

```{r out.width = "95%", include = T, eval = T}

cbPalette <- c( "#0072B2", "#009E73", "#E69F00", "#F0E442", "#D55E00", "#CC79A7", "#56B4E9", "#999999")

sign.hits.df %>% as.matrix() %>% reshape2::melt(var.names = c("ID", "Treatment"), value.name = "cnt") %>%
  ggplot(aes(y = cnt, x = Var2, fill = as.factor(as.numeric(Var2)))) +
    geom_col() +
    geom_text(aes(label = comma(cnt, accuracy = 1L), y = cnt), 
                  stat = "identity", 
                  vjust = -0.2, size = 2.5) + 
    scale_y_continuous(labels = scientific) +
    # scale_fill_viridis(discrete = TRUE, alpha = 0.9, option = "C") +
    labs(title = " ", y = "Count", x = " ") + 
    facet_wrap(~ Var1, ncol = 3) +
    theme(legend.position = "none", 
          legend.title = element_blank(),
          panel.grid.major = element_blank(),
          panel.background = element_blank(),
          plot.title = element_text(size = 10),
          axis.title = element_text(size = 8),
          axis.title.x = element_blank()) +
  scale_fill_manual(values = cbPalette)
```

## Manhattan plots{.tabset .tabset-fade .tabset-pills}

### Delta

```{r eval = F, include = F}
df <- meqtl.delta.full.df[, .(SNP, chr, pos_snp, fdr)]
colnames(df) <- c("SNP", "CHR", "BP", "P")

GetManhattanPlot(df, ylims = c(-log10(fdr.thr), 40), plot.title = "Delta, FDR <= 0.05")

```

### Baseline

```{r eval = F, include = F}
df <- meqtl.veh.full.df[, .(SNP, chr, pos_snp, fdr)]
colnames(df) <- c("SNP", "CHR", "BP", "P")

GetManhattanPlot(df, ylims = c(-log10(fdr.thr), 40), plot.title = "Delta, FDR <= 0.05")

```

### Dex

```{r eval = F, include = F}
df <- meqtl.dex.full.df[, .(SNP, chr, pos_snp, fdr)]
colnames(df) <- c("SNP", "CHR", "BP", "P")

GetManhattanPlot(df, ylims = c(-log10(fdr.thr), 40), plot.title = "Delta, FDR <= 0.05")

```

## Upset plots{.tabset .tabset-fade .tabset-pills}

### meQTL level
  
```{r out.width = "95%", include = T, eval = T}
library(UpSetR)

meqtls.meqtls <- list(delta = meqtl.all.full.df[treatment == "delta", meQTL_ID], 
                      dex = meqtl.all.full.df[treatment == "dex", meQTL_ID], 
                      veh = meqtl.all.full.df[treatment == "veh", meQTL_ID])

upset(fromList(meqtls.meqtls), 
      sets = c("delta", "dex", "veh"),
      nsets = 3, 
      nintersects = 20, 
      mainbar.y.label = "Number of intersections, meQTL", 
      text.scale = 1, 
      keep.order = T,
      sets.bar.color = c( "#0072B2", "#009E73", "#E69F00"), 
      order.by = "freq")
```

### SNP level
  
```{r out.width = "95%", include = T, eval = T}
library(UpSetR)

meqtls.snps <- list(delta = meqtl.delta.full.df$SNP, dex = meqtl.dex.full.df$SNP, veh = meqtl.veh.full.df$SNP)

upset(fromList(meqtls.snps), 
      sets = c("delta", "dex", "veh"),
      nsets = 3, 
      nintersects = 20, 
      mainbar.y.label = "Number of intersections, meSNP", 
      text.scale = 1, 
      keep.order = T,
      sets.bar.color = c("#0072B2", "#009E73", "#E69F00"), 
      order.by = "freq")
```

### CpG level

```{r out.width = "95%", include = T, eval = T}
library(UpSetR)

meqtls.cpg <- list(delta = meqtl.delta.full.df$CpG_ID, dex = meqtl.dex.full.df$CpG_ID, veh = meqtl.veh.full.df$CpG_ID)

upset(fromList(meqtls.cpg), 
      sets = c("delta", "dex", "veh"),
      nsets = 3, 
      nintersects = 20, 
      mainbar.y.label = "Number of intersections, meCpG", 
      text.scale = 1, 
      keep.order = T,
      sets.bar.color = c("#0072B2", "#009E73", "#E69F00"), 
      order.by = "freq")
```

## Scatter plot {.tabset .tabset-fade .tabset-pills}

```{r out.width = "95%", include = T, eval = T}
fdr.thr <- 0.05
plot.title <- paste0("Significant at FDR <= ", fdr.thr, " meQTLs.",
                     "\nResult of MatrixEQTL")
GetScatterPlot2(meqtl.all.full.df, plot.title = plot.title)
```

## Distances

```{r out.width = "95%", include = T, eval = T}
ggplot(meqtl.all.full.df, aes(x = dist, fill = treatment)) + 
  geom_density(alpha = 0.2, aes(color = treatment)) +
  theme(legend.position = c(.9,.9), 
        legend.title = element_blank(),
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        plot.title = element_text(size = 10),
        axis.title = element_text(size = 10)) +
  scale_x_continuous(breaks = c(0, 1e2, 1e3, 1e4, 1e5, 1e6), labels = scientific) +
  scale_y_continuous(labels = scientific) +
  labs(title = paste0("Distribution of cis-meQTLs, FDR = ", fdr.thr), 
       x = "Distance of CpG meQTL to SNP", 
       y = "Density") +
  scale_fill_manual(values = cbPalette)
```

```{r out.width = "100%", include = T, eval = T}
library(mltools)
bins.df <- data.frame(DistanceInterval = bin_data(data.table::data.table(meqtl.all.full.df), binCol = "dist", bins = c(0, 1, 500, 1e3+1, 5e3+1,
                                                                                                                       1e4+1, 5e4+1, 1e5+1, 5e5+1,
                                                                                                                       1e6+1), returnDT = F))
levels(bins.df$DistanceInterval) <- c("0", "(0; 500]", "(500; 1e3]", "(1e3; 5e3]", "(5e3; 1e4]", "(1e4; 5e4]", "(5e4; 1e5]", "[1e5; 5e5)", "[5e5; 1e6]")
bins.df <- cbind(bins.df, treatment = meqtl.all.full.df$treatment)

ggplot(bins.df, aes(DistanceInterval, fill = treatment)) + 
  geom_bar(position = position_dodge()) +
  stat_count(geom = "text", 
             aes(label = comma(..count.., accuracy = 1L)),
             position = position_dodge(1),  vjust = -1, colour = "black", cex = 2) +
  theme(legend.position = c(.1,.9), 
        legend.title = element_blank(),
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        axis.text.y = element_blank(),
        plot.title = element_text(size = 10),
        axis.title = element_text(size = 8)) +
  labs(title = paste0("Distribution of cis-meQTLs, FDR = ", fdr.thr), 
       x = "Distance Interval, bp", 
       y = "No. cis-meQTLs") + 
  scale_fill_manual(values = cbPalette)
```
***


```{r include = F, eval = F}
meqtl.grp.overlaps.all       <- intersect(intersect(meqtls.meqtls$veh, meqtls.meqtls$delta), meqtls.meqtls$dex)
meqtl.grp.overlaps.delta.veh <- setdiff(intersect(meqtls.meqtls$veh, meqtls.meqtls$delta), meqtls.meqtls$dex)
meqtl.grp.overlaps.delta.dex <- setdiff(intersect(meqtls.meqtls$dex, meqtls.meqtls$delta), meqtls.meqtls$veh)
meqtl.grp.only.delta         <- setdiff(setdiff(meqtls.meqtls$delta, meqtls.meqtls$dex), meqtls.meqtls$veh)
```

<!-- Annotate data -->

```{r include = F, eval = F}
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
library(ChIPseeker)
library(org.Hs.eg.db)

out.dir.pre  <- "~/bio/code/mpip/dex-stim-human-array/output/data/integrative/matrixEQTL/primary_meqtl_results/"

meqtl.overlap.snp.all.df <- meqtl.all.full.df[meQTL_ID %in% meqtl.grp.overlaps.all]
meqtl.overlap.snp.all.gr <- annotate_with_chipseeker(meqtl.overlap.snp.all.df, "chr", "pos_snp", "pos_snp", "SNP")
saveRDS(meqtl.overlap.snp.all.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_snp_anno_delta_dex_veh_gr.rds"))

meqtl.overlap.snp.delta.veh.df <- meqtl.all.full.df[meQTL_ID %in% meqtl.grp.overlaps.delta.veh]
meqtl.overlap.snp.delta.veh.gr <- annotate_with_chipseeker(meqtl.overlap.snp.delta.veh.df, "chr", "pos_snp", "pos_snp", "SNP")
saveRDS(meqtl.overlap.snp.delta.veh.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_snp_anno_delta_veh_gr.rds"))

meqtl.overlap.snp.delta.dex.df <- meqtl.all.full.df[meQTL_ID %in% meqtl.grp.overlaps.delta.dex]
meqtl.overlap.snp.delta.dex.gr <- annotate_with_chipseeker(meqtl.overlap.snp.delta.dex.df, "chr", "pos_snp", "pos_snp", "SNP")
saveRDS(meqtl.overlap.snp.delta.dex.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_snp_anno_delta_dex_gr.rds"))

meqtl.only.snp.delta.df <- meqtl.all.full.df[meQTL_ID %in% meqtl.grp.only.delta]
meqtl.only.snp.delta.gr <- annotate_with_chipseeker(meqtl.only.snp.delta.df, "chr", "pos_snp", "pos_snp", "SNP")
saveRDS(meqtl.only.snp.delta.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_snp_anno_only_delta_gr.rds"))
```

# Functional annotation

## meQTL level

<!-- ### SNP level -->
  
### Manhattan plots{.tabset .tabset-fade .tabset-pills}

#### Veh + Dex + Delta

```{r}
overlaps.all       <- intersect(intersect(meqtls.meqtls$veh, meqtls.meqtls$delta), meqtls.meqtls$dex)
df <- meqtl.all.full.df[meQTL_ID %in% overlaps.all]
df <- df[, .(SNP, chr, pos_snp, fdr)]
colnames(df) <- c("SNP", "CHR", "BP", "P")

GetManhattanPlot(df, ylims = c(-log10(fdr.thr), -log10(min(df$P)) + 1), plot.title = "Intersect(delta, dex, veh), FDR <= 0.05")
```

#### Dex + Delta

```{r}
overlaps.delta.dex <- setdiff(intersect(meqtls.meqtls$dex, meqtls.meqtls$delta), meqtls.meqtls$veh)
df <- meqtl.all.full.df[meQTL_ID %in% overlaps.delta.dex]
df <- df[, .(SNP, chr, pos_snp, fdr)]
colnames(df) <- c("SNP", "CHR", "BP", "P")

GetManhattanPlot(df, ylims = c(-log10(fdr.thr), -log10(min(df$P)) + 1), plot.title = "Intersect(delta, dex), FDR <= 0.05")
```

#### Veh + Delta

```{r}
overlaps.delta.veh <- setdiff(intersect(meqtls.meqtls$veh, meqtls.meqtls$delta), meqtls.meqtls$dex)
df <- meqtl.all.full.df[meQTL_ID %in% overlaps.delta.veh]
df <- df[, .(SNP, chr, pos_snp, fdr)]
colnames(df) <- c("SNP", "CHR", "BP", "P")

GetManhattanPlot(df, ylims = c(-log10(fdr.thr), -log10(min(df$P)) + 1), plot.title = "Intersect(delta, veh), FDR <= 0.05")
```

#### Only delta

```{r}
only.delta <- setdiff(setdiff(meqtls.meqtls$delta, meqtls.meqtls$dex), meqtls.meqtls$veh)
df <- meqtl.all.full.df[meQTL_ID %in% only.delta]
df <- df[, .(SNP, chr, pos_snp, fdr)]
colnames(df) <- c("SNP", "CHR", "BP", "P")

GetManhattanPlot(df, ylims = c(-log10(fdr.thr), -log10(min(df$P)) + 1), plot.title = "Only delta meQTLs, FDR <= 0.05")
```

### Visualisation {.tabset .tabset-fade .tabset-pills}

```{r, include=F, eval=T}
eqtm.in.pre  <- "~/bio/code/mpip/dex-stim-human-array/data/integrative/matrixEQTL/"

snp.df.fn <- paste0(eqtm.in.pre, "snp_mtrx.csv")
snp.df    <- fread(snp.df.fn)

methyl.beta.df.fn   <- paste0(eqtm.in.pre, "methyl_beta_mtrx_dex.csv")
methyl.beta.dex.df  <- fread(methyl.beta.df.fn) 

methyl.beta.df.fn   <- paste0(eqtm.in.pre, "methyl_beta_mtrx_veh.csv")
methyl.beta.veh.df  <- fread(methyl.beta.df.fn) 

all(colnames(snp.df)[-1] == colnames(methyl.beta.dex.df)[-1])
all(colnames(snp.df)[-1] == colnames(methyl.beta.veh.df)[-1])
```

####  Dex + Veh + Delta

```{r include = T, eval = T}
# paste0("Scatter plot for the independent significant at FDR <= ", fdr.thr, " meQTLs")
meqtl.id       <- meqtl.all.full.df[meQTL_ID %in% overlaps.all][treatment == "delta"][fdr == min(fdr), meQTL_ID]
selected.meqtl <- meqtl.all.full.df[meQTL_ID %in% meqtl.id] # beta == max(beta)

kable(selected.meqtl %>% 
        dplyr::select(SNP, CpG_ID, FC = beta, `t-stat`, `p-value`, FDR = fdr, Treatment = treatment) %>% 
        mutate_if(is.numeric, funs(as.character(signif(., 3)))))
```

```{r, eval = T, include = F}
plot.title <- paste0(# "Independent meQTL ", selected.meqtl$meQTL_ID, 
                     "The most significant across intersections of DELTA, VEH + DEX meQTLs: ",
                     "FC = ", signif(selected.meqtl$beta, 2), " and FDR = ", signif(selected.meqtl$fdr, 2))
```
```{r out.width = "95%", include = F, eval = F}
GetScatterPlot(meqtl.all.full.df, selected.meqtl, fdr.thr = 0.05, plot.title = plot.title)
```
```{r out.width = "95%", include = T, eval = T}
ProcessGetBoxPlot(methyl.beta.veh.df, methyl.beta.dex.df, snp.df, selected.meqtl[1], fdr.thr = 0.05, 
                  plot.title = plot.title)
```  

####  Veh + Delta

```{r include = T, eval = T}
# paste0("Scatter plot for the independent significant at FDR <= ", fdr.thr, " meQTLs")
meqtl.id       <- meqtl.all.full.df[meQTL_ID %in% overlaps.delta.veh][treatment == "delta"][fdr == min(fdr), meQTL_ID]
selected.meqtl <- meqtl.all.full.df[meQTL_ID %in% meqtl.id] # beta == max(beta)

kable(selected.meqtl %>% 
        dplyr::select(SNP, CpG_ID, FC = beta, `t-stat`, `p-value`, FDR = fdr, Treatment = treatment) %>% 
        mutate_if(is.numeric, funs(as.character(signif(., 3)))))
```

```{r, eval = T, include = F}
plot.title <- paste0(# "Independent meQTL ", selected.meqtl$meQTL_ID, 
                     "The most significant across intersections of DELTA and VEH meQTLs: ",
                     "FC = ", signif(selected.meqtl$beta, 2), " and FDR = ", signif(selected.meqtl$fdr, 2))
```
```{r out.width = "95%", include = F, eval = F}
GetScatterPlot(meqtl.all.full.df, selected.meqtl, fdr.thr = 0.05, plot.title = plot.title)
```
```{r out.width = "95%", include = T, eval = T}
ProcessGetBoxPlot(methyl.beta.veh.df, methyl.beta.dex.df, snp.df, selected.meqtl[1], fdr.thr = 0.05, 
                  plot.title = plot.title)
```  

####  Dex + Delta

```{r include = T, eval = T}
# paste0("Scatter plot for the independent significant at FDR <= ", fdr.thr, " meQTLs")
meqtl.id       <- meqtl.all.full.df[meQTL_ID %in% overlaps.delta.dex][treatment == "delta"][fdr == min(fdr), meQTL_ID]
selected.meqtl <- meqtl.all.full.df[meQTL_ID %in% meqtl.id] # beta == max(beta)

kable(selected.meqtl %>% 
        dplyr::select(SNP, CpG_ID, FC = beta, `t-stat`, `p-value`, FDR = fdr, Treatment = treatment) %>% 
        mutate_if(is.numeric, funs(as.character(signif(., 3)))))
```

```{r, eval = T, include = F}
plot.title <- paste0(# "Independent meQTL ", selected.meqtl$meQTL_ID, 
                     "The most significant across intersections of DELTA and DEX meQTLs: ",
                     "FC = ", signif(selected.meqtl$beta, 2), " and FDR = ", signif(selected.meqtl$fdr, 2))
```
```{r out.width = "95%", include = F, eval = F}
GetScatterPlot(meqtl.all.full.df, selected.meqtl, fdr.thr = 0.05, plot.title = plot.title)
```
```{r out.width = "95%", include = T, eval = T}
ProcessGetBoxPlot(methyl.beta.veh.df, methyl.beta.dex.df, snp.df, selected.meqtl[16], fdr.thr = 0.05, 
                  plot.title = plot.title)
```  

#### Only delta

```{r include = T, eval = T}
# paste0("Scatter plot for the independent significant at FDR <= ", fdr.thr, " meQTLs")
meqtl.id       <- meqtl.all.full.df[meQTL_ID %in% only.delta][treatment == "delta"][fdr == min(fdr), meQTL_ID]
selected.meqtl <- meqtl.all.full.df[meQTL_ID %in% meqtl.id] # beta == max(beta)

kable(selected.meqtl %>% 
        dplyr::select(SNP, CpG_ID, FC = beta, `t-stat`, `p-value`, FDR = fdr, Treatment = treatment) %>% 
        mutate_if(is.numeric, funs(as.character(signif(., 3)))))
```

```{r, eval = T, include = F}
plot.title <- paste0(# "Independent meQTL ", selected.meqtl$meQTL_ID, 
                     "The most significant across unique DELTA meQTLs: ",
                     "FC = ", signif(selected.meqtl$beta, 2), " and FDR = ", signif(selected.meqtl$fdr, 2))
```
```{r out.width = "95%", include = F, eval = F}
GetScatterPlot(meqtl.all.full.df, selected.meqtl, fdr.thr = 0.05, plot.title = plot.title)
```
```{r out.width = "95%", include = T, eval = T}
ProcessGetBoxPlot(methyl.beta.veh.df, methyl.beta.dex.df, snp.df, selected.meqtl[1], fdr.thr = 0.05, 
                  plot.title = plot.title)
```  


### SNP annotation 

```{r eval = T, include = F}
out.dir.pre  <- "~/bio/code/mpip/dex-stim-human-array/output/data/integrative/matrixEQTL/primary_meqtl_results/"

meqtl.overlap.all.gr       <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_snp_anno_delta_dex_veh_gr.rds"))
meqtl.overlap.delta.veh.gr <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_snp_anno_delta_veh_gr.rds"))
meqtl.overlap.delta.dex.gr <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_snp_anno_delta_dex_gr.rds"))
meqtl.only.delta.gr        <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_snp_anno_only_delta_gr.rds"))
```

```{r}
delta.anno.stat.df <- meqtl.only.delta.gr@annoStat
delta.anno.stat.df[["Model"]] <- paste0("only delta \n N = ", length(meqtl.only.delta.gr@anno)) 

all.anno.stat.df <- meqtl.overlap.all.gr@annoStat
all.anno.stat.df[["Model"]] <- paste0("intersect \n (delta, veh, dex), \n N = ", length(meqtl.overlap.all.gr@anno))

delta.veh.anno.stat.df <- meqtl.overlap.delta.veh.gr@annoStat
delta.veh.anno.stat.df[["Model"]] <- paste0("intersect \n (delta, veh) \n N = ", length(meqtl.overlap.delta.veh.gr@anno))

delta.dex.anno.stat.df <- meqtl.overlap.delta.dex.gr@annoStat
delta.dex.anno.stat.df[["Model"]] <-  paste0("intersect \n (delta, dex) \n N = ", length(meqtl.overlap.delta.dex.gr@anno))

anno.stat.df <- rbind(all.anno.stat.df, delta.veh.anno.stat.df, delta.dex.anno.stat.df, delta.anno.stat.df)

anno.stat.df$Feature   <- factor(anno.stat.df$Feature)
anno.stat.df$Frequency <- signif(anno.stat.df$Frequency, 3)
anno.stat.df$Model     <- factor(anno.stat.df$Model)
levels(anno.stat.df$Model) <- c(unique(all.anno.stat.df$Model), 
                                unique(delta.veh.anno.stat.df$Model), 
                                unique(delta.dex.anno.stat.df$Model), 
                                unique(delta.anno.stat.df$Model))

cbPalette <- c("#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499", "#44AA99", "#999933", "#882255", "#661100", "#6699CC", "#888888")

ggplot(anno.stat.df, aes(x = Model, y = Frequency, fill = Feature)) + 
  geom_bar( position = "fill", stat = "identity") + 
  geom_text(data = subset(anno.stat.df, Frequency > 2),
            aes(label = Frequency), 
            position = position_fill(vjust = .5), size = 3) +
  labs(x = "",
       y = "Percentage of SNPs", 
       title = "meSNP annotation from UCSC for the hg19 genome build using \nTxDb.Hsapiens.UCSC.hg19.knownGene and ChIPseeker Bioconductor R packages \n\nmeQTL level, N is the number of SNPs") +
  theme(legend.position = "right",
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        plot.title = element_text(size = 8),
        axis.title = element_text(size = 8),
        axis.text.x = element_text(angle = 0, hjust = 0.5)) +
   scale_fill_manual("", values = cbPalette)
```


### CpG annotation

<!-- Annotate data -->

```{r include = F, eval = F}
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
library(ChIPseeker)
library(org.Hs.eg.db)

out.dir.pre  <- "~/bio/code/mpip/dex-stim-human-array/output/data/integrative/matrixEQTL/primary_meqtl_results/"

meqtl.overlap.cpg.all.df <- meqtl.all.full.df[meQTL_ID %in% meqtl.grp.overlaps.all]
meqtl.overlap.cpg.all.gr <- annotate_with_chipseeker(meqtl.overlap.cpg.all.df, "chr", "pos_cpg", "pos_cpg", "CpG_ID")
saveRDS(meqtl.overlap.cpg.all.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_cpg_anno_delta_dex_veh_gr.rds"))

meqtl.overlap.cpg.delta.veh.df <- meqtl.all.full.df[meQTL_ID %in% meqtl.grp.overlaps.delta.veh]
meqtl.overlap.cpg.delta.veh.gr <- annotate_with_chipseeker(meqtl.overlap.cpg.delta.veh.df, "chr", "pos_cpg", "pos_cpg", "CpG_ID")
saveRDS(meqtl.overlap.cpg.delta.veh.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_cpg_anno_delta_veh_gr.rds"))

meqtl.overlap.cpg.delta.dex.df <- meqtl.all.full.df[meQTL_ID %in% meqtl.grp.overlaps.delta.dex]
meqtl.overlap.cpg.delta.dex.gr <- annotate_with_chipseeker(meqtl.overlap.cpg.delta.dex.df, "chr", "pos_cpg", "pos_cpg", "CpG_ID")
saveRDS(meqtl.overlap.cpg.delta.dex.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_cpg_anno_delta_dex_gr.rds"))

meqtl.only.cpg.delta.df <- meqtl.all.full.df[meQTL_ID %in% meqtl.grp.only.delta]
meqtl.only.cpg.delta.gr <- annotate_with_chipseeker(meqtl.only.cpg.delta.df, "chr", "pos_cpg", "pos_cpg", "CpG_ID")
saveRDS(meqtl.only.cpg.delta.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_cpg_anno_only_delta_gr.rds"))
```

```{r eval = T, include = F}
out.dir.pre  <- "~/bio/code/mpip/dex-stim-human-array/output/data/integrative/matrixEQTL/primary_meqtl_results/"

meqtl.overlap.all.gr       <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_cpg_anno_delta_dex_veh_gr.rds"))
meqtl.overlap.delta.veh.gr <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_cpg_anno_delta_veh_gr.rds"))
meqtl.overlap.delta.dex.gr <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_cpg_anno_delta_dex_gr.rds"))
meqtl.only.delta.gr        <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_meqtl_level_cpg_anno_only_delta_gr.rds"))
```

```{r}
delta.anno.stat.df <- meqtl.only.delta.gr@annoStat
delta.anno.stat.df[["Model"]] <- paste0("only delta \n N = ", length(meqtl.only.delta.gr@anno)) 

all.anno.stat.df <- meqtl.overlap.all.gr@annoStat
all.anno.stat.df[["Model"]] <- paste0("intersect \n (delta, veh, dex), \n N = ", length(meqtl.overlap.all.gr@anno))

delta.veh.anno.stat.df <- meqtl.overlap.delta.veh.gr@annoStat
delta.veh.anno.stat.df[["Model"]] <- paste0("intersect \n (delta, veh) \n N = ", length(meqtl.overlap.delta.veh.gr@anno))

delta.dex.anno.stat.df <- meqtl.overlap.delta.dex.gr@annoStat
delta.dex.anno.stat.df[["Model"]] <-  paste0("intersect \n (delta, dex) \n N = ", length(meqtl.overlap.delta.dex.gr@anno))

anno.stat.df <- rbind(all.anno.stat.df, delta.veh.anno.stat.df, delta.dex.anno.stat.df, delta.anno.stat.df)

anno.stat.df$Feature   <- factor(anno.stat.df$Feature)
anno.stat.df$Frequency <- signif(anno.stat.df$Frequency, 3)
anno.stat.df$Model     <- factor(anno.stat.df$Model)
levels(anno.stat.df$Model) <- c(unique(all.anno.stat.df$Model), 
                                unique(delta.veh.anno.stat.df$Model), 
                                unique(delta.dex.anno.stat.df$Model), 
                                unique(delta.anno.stat.df$Model))

cbPalette <- c("#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499", "#44AA99", "#999933", "#882255", "#661100", "#6699CC", "#888888")

ggplot(anno.stat.df, aes(x = Model, y = Frequency, fill = Feature)) + 
  geom_bar( position = "fill", stat = "identity") + 
  geom_text(data = subset(anno.stat.df, Frequency > 2),
            aes(label = Frequency), 
            position = position_fill(vjust = .5), size = 3) +
  labs(x = "",
       y = "Percentage of CpGs", 
       title = "meCpG annotation from UCSC for the hg19 genome build using \nTxDb.Hsapiens.UCSC.hg19.knownGene and ChIPseeker Bioconductor R packages \n\nmeQTL level, N is the number of CpGs") +
  theme(legend.position = "right",
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        plot.title = element_text(size = 8),
        axis.title = element_text(size = 8),
        axis.text.x = element_text(angle = 0, hjust = 0.5)) +
   scale_fill_manual("", values = cbPalette)
```

***


## meSNP level

```{r include = F, eval = F}
snp.grp.overlaps.all       <- intersect(intersect(meqtls.snps$veh, meqtls.snps$delta), meqtls.snps$dex)
snp.grp.overlaps.delta.veh <- setdiff(intersect(meqtls.snps$veh, meqtls.snps$delta), meqtls.snps$dex)
snp.grp.overlaps.delta.dex <- setdiff(intersect(meqtls.snps$dex, meqtls.snps$delta), meqtls.snps$veh)
snp.grp.only.delta         <- setdiff(setdiff(meqtls.snps$delta, meqtls.snps$dex), meqtls.snps$veh)
```

<!-- Annotate data -->

```{r eval = F, include = F}
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
library(ChIPseeker)
library(org.Hs.eg.db)

out.dir.pre  <- "~/bio/code/mpip/dex-stim-human-array/output/data/integrative/matrixEQTL/primary_meqtl_results/"

meqtl.overlap.snp.all.df <- meqtl.all.full.df[SNP %in% snp.grp.overlaps.all]
meqtl.overlap.snp.all.gr <- annotate_with_chipseeker(meqtl.overlap.snp.all.df, "chr", "pos_snp", "pos_snp", "SNP")
saveRDS(meqtl.overlap.snp.all.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_snps_level_delta_dex_veh_gr.rds"))

meqtl.overlap.snp.delta.veh.df <- meqtl.all.full.df[SNP %in% snp.grp.overlaps.delta.veh]
meqtl.overlap.snp.delta.veh.gr <- annotate_with_chipseeker(meqtl.overlap.snp.delta.veh.df, "chr", "pos_snp", "pos_snp", "SNP")
saveRDS(meqtl.overlap.snp.delta.veh.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_snps_level_delta_veh_gr.rds"))

meqtl.overlap.snp.delta.dex.df <- meqtl.all.full.df[SNP %in% snp.grp.overlaps.delta.dex]
meqtl.overlap.snp.delta.dex.gr <- annotate_with_chipseeker(meqtl.overlap.snp.delta.dex.df, "chr", "pos_snp", "pos_snp", "SNP")
saveRDS(meqtl.overlap.snp.delta.dex.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_snps_level_delta_dex_gr.rds"))

meqtl.only.snp.delta.df <- meqtl.all.full.df[SNP %in% snp.grp.only.delta]
meqtl.only.snp.delta.gr <- annotate_with_chipseeker(meqtl.only.snp.delta.df, "chr", "pos_snp", "pos_snp", "SNP")
saveRDS(meqtl.only.snp.delta.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_snps_level_only_delta_gr.rds"))
```

```{r eval = T, include = F}
out.dir.pre  <- "~/bio/code/mpip/dex-stim-human-array/output/data/integrative/matrixEQTL/primary_meqtl_results/"

meqtl.overlap.all.gr       <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_snps_level_delta_dex_veh_gr.rds"))
meqtl.overlap.delta.veh.gr <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_snps_level_delta_veh_gr.rds"))
meqtl.overlap.delta.dex.gr <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_snps_level_delta_dex_gr.rds"))
meqtl.only.delta.gr        <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_snps_level_only_delta_gr.rds"))
```


```{r}
delta.anno.stat.df <- meqtl.only.delta.gr@annoStat
delta.anno.stat.df[["Model"]] <- paste0("only delta \n N = ", length(meqtl.only.delta.gr@anno)) 

all.anno.stat.df <- meqtl.overlap.all.gr@annoStat
all.anno.stat.df[["Model"]] <- paste0("intersect \n (delta, veh, dex), \n N = ", length(meqtl.overlap.all.gr@anno))

delta.veh.anno.stat.df <- meqtl.overlap.delta.veh.gr@annoStat
delta.veh.anno.stat.df[["Model"]] <- paste0("intersect \n (delta, veh) \n N = ", length(meqtl.overlap.delta.veh.gr@anno))

delta.dex.anno.stat.df <- meqtl.overlap.delta.dex.gr@annoStat
delta.dex.anno.stat.df[["Model"]] <-  paste0("intersect \n (delta, dex) \n N = ", length(meqtl.overlap.delta.dex.gr@anno))

anno.stat.df <- rbind(all.anno.stat.df, delta.veh.anno.stat.df, delta.dex.anno.stat.df, delta.anno.stat.df)

anno.stat.df$Feature   <- factor(anno.stat.df$Feature)
anno.stat.df$Frequency <- signif(anno.stat.df$Frequency, 3)
anno.stat.df$Model     <- factor(anno.stat.df$Model)
levels(anno.stat.df$Model) <- c(unique(all.anno.stat.df$Model), 
                                unique(delta.veh.anno.stat.df$Model), 
                                unique(delta.dex.anno.stat.df$Model), 
                                unique(delta.anno.stat.df$Model))

cbPalette <- c("#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499", "#44AA99", "#999933", "#882255", "#661100", "#6699CC", "#888888")

ggplot(anno.stat.df, aes(x = Model, y = Frequency, fill = Feature)) + 
  geom_bar( position = "fill", stat = "identity") + 
  geom_text(data = subset(anno.stat.df, Frequency > 2),
            aes(label = Frequency), 
            position = position_fill(vjust = .5), size = 3) +
  labs(x = "",
       y = "Percentage of SNPs", 
       title = "meSNP annotation from UCSC for the hg19 genome build using \nTxDb.Hsapiens.UCSC.hg19.knownGene and ChIPseeker Bioconductor R packages \n\nmeSNP level, N is the number of SNPs") +
  theme(legend.position = "right",
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        plot.title = element_text(size = 8),
        axis.title = element_text(size = 8),
        axis.text.x = element_text(angle = 0, hjust = 0.5)) +
   scale_fill_manual("", values = cbPalette)
```
***

## meCpG level

```{r include = F, eval = F}
meqtls.cpg <- list(delta = meqtl.delta.full.df$CpG_ID, dex = meqtl.dex.full.df$CpG_ID, veh = meqtl.veh.full.df$CpG_ID)

overlaps.all       <- intersect(intersect(meqtls.cpg$veh, meqtls.cpg$delta), meqtls.cpg$dex)
overlaps.delta.veh <- setdiff(intersect(meqtls.cpg$veh, meqtls.cpg$delta), meqtls.cpg$dex)
overlaps.delta.dex <- setdiff(intersect(meqtls.cpg$dex, meqtls.cpg$delta), meqtls.cpg$veh)
only.delta         <- setdiff(setdiff(meqtls.cpg$delta, meqtls.cpg$dex), meqtls.cpg$veh)
```

<!-- Annotate data -->

```{r eval = F, include = F}
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
library(ChIPseeker)
library(org.Hs.eg.db)

out.dir.pre  <- "~/bio/code/mpip/dex-stim-human-array/output/data/integrative/matrixEQTL/primary_meqtl_results/"

meqtl.overlap.all.df <- meqtl.all.full.df[CpG_ID %in% overlaps.all]
meqtl.overlap.all.gr <- annotate_with_chipseeker(meqtl.overlap.all.df, "chr", "pos_cpg", "pos_cpg", "CpG_ID")
saveRDS(meqtl.overlap.all.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_cpg_level_delta_dex_veh_gr.rds"))

meqtl.overlap.delta.veh.df <- meqtl.all.full.df[CpG_ID %in% overlaps.delta.veh]
meqtl.overlap.delta.veh.gr <- annotate_with_chipseeker(meqtl.overlap.delta.veh.df, "chr", "pos_cpg", "pos_cpg", "CpG_ID")
saveRDS(meqtl.overlap.delta.veh.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_cpg_level_delta_veh_gr.rds"))

meqtl.overlap.delta.dex.df <- meqtl.all.full.df[CpG_ID %in% overlaps.delta.dex]
meqtl.overlap.delta.dex.gr <- annotate_with_chipseeker(meqtl.overlap.delta.dex.df, "chr", "pos_cpg", "pos_cpg", "CpG_ID")
saveRDS(meqtl.overlap.delta.dex.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_cpg_level_delta_dex_gr.rds"))

meqtl.only.delta.df <- meqtl.all.full.df[CpG_ID %in% only.delta]
meqtl.only.delta.gr <- annotate_with_chipseeker(meqtl.only.delta.df, "chr", "pos_cpg", "pos_cpg", "CpG_ID")
saveRDS(meqtl.only.delta.gr, file =  paste0(out.dir.pre, "meqtl_overlaps_cpg_level_only_delta_gr.rds"))
```

```{r eval = T, include = F}
out.dir.pre  <- "~/bio/code/mpip/dex-stim-human-array/output/data/integrative/matrixEQTL/primary_meqtl_results/"

meqtl.overlap.all.gr       <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_cpg_level_delta_dex_veh_gr.rds"))
meqtl.overlap.delta.veh.gr <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_cpg_level_delta_veh_gr.rds"))
meqtl.overlap.delta.dex.gr <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_cpg_level_delta_dex_gr.rds"))
meqtl.only.delta.gr        <- readRDS(file =  paste0(out.dir.pre, "meqtl_overlaps_cpg_level_only_delta_gr.rds"))
```


```{r}
delta.anno.stat.df <- meqtl.only.delta.gr@annoStat
delta.anno.stat.df[["Model"]] <- paste0("only delta \n N = ", length(meqtl.only.delta.gr@anno)) 

all.anno.stat.df <- meqtl.overlap.all.gr@annoStat
all.anno.stat.df[["Model"]] <- paste0("intersect \n (delta, veh, dex), \n N = ", length(meqtl.overlap.all.gr@anno))

delta.veh.anno.stat.df <- meqtl.overlap.delta.veh.gr@annoStat
delta.veh.anno.stat.df[["Model"]] <- paste0("intersect \n (delta, veh) \n N = ", length(meqtl.overlap.delta.veh.gr@anno))

delta.dex.anno.stat.df <- meqtl.overlap.delta.dex.gr@annoStat
delta.dex.anno.stat.df[["Model"]] <-  paste0("intersect \n (delta, dex) \n N = ", length(meqtl.overlap.delta.dex.gr@anno))

anno.stat.df <- rbind(all.anno.stat.df, delta.veh.anno.stat.df, delta.dex.anno.stat.df, delta.anno.stat.df)

anno.stat.df$Feature   <- factor(anno.stat.df$Feature)
anno.stat.df$Frequency <- signif(anno.stat.df$Frequency, 3)
anno.stat.df$Model     <- factor(anno.stat.df$Model)
levels(anno.stat.df$Model) <- c(unique(all.anno.stat.df$Model), 
                                unique(delta.veh.anno.stat.df$Model), 
                                unique(delta.dex.anno.stat.df$Model), 
                                unique(delta.anno.stat.df$Model))

cbPalette <- c("#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499", "#44AA99", "#999933", "#882255", "#661100", "#6699CC", "#888888")

ggplot(anno.stat.df, aes(x = Model, y = Frequency, fill = Feature)) + 
  geom_bar( position = "fill", stat = "identity") + 
  geom_text(data = subset(anno.stat.df, Frequency > 2),
            aes(label = Frequency), 
            position = position_fill(vjust = .5), size = 3) +
  labs(x = "",
       y = "Percentage of CpGs", 
       title = "meCpG annotation from UCSC for the hg19 genome build using \nTxDb.Hsapiens.UCSC.hg19.knownGene and ChIPseeker Bioconductor R packages \n\nmeCpG level, N is the number of CpGs") +
  theme(legend.position = "right",
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        plot.title = element_text(size = 8),
        axis.title = element_text(size = 8),
        axis.text.x = element_text(angle = 0, hjust = 0.5)) +
   scale_fill_manual("", values = cbPalette)
```

